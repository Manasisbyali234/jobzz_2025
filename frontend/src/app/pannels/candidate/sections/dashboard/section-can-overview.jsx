// import CountUp from "react-countup";

// function SectionCandidateOverview() {
//     return (
//         <>
//             <div className="wt-admin-right-page-header">
//                 <h2>Randall Henderson</h2>
//                 <p>IT Contractor</p>
//             </div>

//             <div className="twm-dash-b-blocks mb-5">
//                 <div className="row">
//                     {/* Card 1 - Credits Available */}
//                     <div className="col-xl-6 col-lg-6 col-md-12 mb-3">
//                         <div className="panel panel-default">
//                             <div className="panel-body wt-panel-body dashboard-card-2" style={{ backgroundColor: '#f0f4ff' }}>
//                                 <div className="wt-card-wrap-2 d-flex align-items-center justify-content-between">
//                                     <div className="wt-card-icon-2"><i className="flaticon-job" /></div>
//                                     <div className="wt-card-right counter fw-bold fs-4 text-primary">
//                                         <CountUp end={25} duration={2} />
//                                     </div>
//                                 </div>
//                                 <div className="wt-card-bottom-2 mt-2">
//                                     <h4 className="m-b0">Credits Available</h4>
//                                 </div>
//                             </div>
//                         </div>
//                     </div>

//                     {/* Card 2 - Application Sent */}
//                     <div className="col-xl-6 col-lg-6 col-md-12 mb-3">
//                         <div className="panel panel-default">
//                             <div className="panel-body wt-panel-body dashboard-card-2" style={{ backgroundColor: '#e0f7fa' }}>
//                                 <div className="wt-card-wrap-2 d-flex align-items-center justify-content-between">
//                                     <div className="wt-card-icon-2"><i className="flaticon-resume" /></div>
//                                     <div className="wt-card-right counter fw-bold fs-4 text-info">
//                                         <CountUp end={435} duration={2} />
//                                     </div>
//                                 </div>
//                                 <div className="wt-card-bottom-2 mt-2">
//                                     <h4 className="m-b0">Application Sent</h4>
//                                 </div>
//                             </div>
//                         </div>
//                     </div>

//                     {/* Card 3 - In Progress */}
//                     <div className="col-xl-6 col-lg-6 col-md-12 mb-3">
//                         <div className="panel panel-default">
//                             <div className="panel-body wt-panel-body dashboard-card-2" style={{ backgroundColor: '#fff3e0' }}>
//                                 <div className="wt-card-wrap-2 d-flex align-items-center justify-content-between">
//                                     <div className="wt-card-icon-2"><i className="flaticon-envelope" /></div>
//                                     <div className="wt-card-right counter fw-bold fs-4 text-warning">
//                                         <CountUp end={28} duration={2} />
//                                     </div>
//                                 </div>
//                                 <div className="wt-card-bottom-2 mt-2">
//                                     <h4 className="m-b0">In Progress</h4>
//                                 </div>
//                             </div>
//                         </div>
//                     </div>

//                     {/* Card 4 - Assessments */}
//                     <div className="col-xl-6 col-lg-6 col-md-12 mb-3">
//                         <div className="panel panel-default">
//                             <div className="panel-body wt-panel-body dashboard-card-2" style={{ backgroundColor: '#e8f5e9' }}>
//                                 <div className="wt-card-wrap-2 d-flex align-items-center justify-content-between">
//                                     <div className="wt-card-icon-2"><i className="flaticon-bell" /></div>
//                                     <div className="wt-card-right counter fw-bold fs-4 text-success">
//                                         <CountUp end={18} duration={2} />
//                                     </div>
//                                 </div>
//                                 <div className="wt-card-bottom-2 mt-2">
//                                     <h4 className="m-b0">Assessments</h4>
//                                 </div>
//                             </div>
//                         </div>
//                     </div>
//                 </div>
//             </div>
//         </>
//     );
// }

// export default SectionCandidateOverview;

// import CountUp from "react-countup";

// function SectionCandidateOverview() {
// 	return (
// 		<>
// 			<div className="wt-admin-right-page-header">
// 				<h2>Randall Henderson</h2>
// 				<p>IT Contractor</p>
// 			</div>

// 			<div className="twm-dash-b-blocks mb-5">
// 				<div className="row">
// 					{/* Card 1 - Credits Available */}
// 					<div className="col-xl-6 col-lg-6 col-md-12 mb-3">
// 						<div className="panel panel-default">
// 							<div
// 								className="panel-body wt-panel-body dashboard-card-2"
// 								style={{ backgroundColor: "#f0f4ff" }}
// 							>
// 								<div className="wt-card-wrap-2 d-flex align-items-center justify-content-between">
// 									<div className="wt-card-icon-2">
// 										<i className="flaticon-job" />
// 									</div>
// 									<div className="wt-card-right counter fw-bold fs-4 text-primary">
// 										<CountUp end={25} duration={2} />
// 									</div>
// 								</div>
// 								<div className="wt-card-bottom-2 mt-2">
// 									<h4 className="m-b0">Credits Available</h4>
// 								</div>
// 							</div>
// 						</div>
// 					</div>

// 					{/* Card 2 - Application Sent */}
// 					<div className="col-xl-6 col-lg-6 col-md-12 mb-3">
// 						<div className="panel panel-default">
// 							<div
// 								className="panel-body wt-panel-body dashboard-card-2"
// 								style={{ backgroundColor: "#e0f7fa" }}
// 							>
// 								<div className="wt-card-wrap-2 d-flex align-items-center justify-content-between">
// 									<div className="wt-card-icon-2">
// 										<i className="flaticon-resume" />
// 									</div>
// 									<div className="wt-card-right counter fw-bold fs-4 text-info">
// 										<CountUp end={435} duration={2} />
// 									</div>
// 								</div>
// 								<div className="wt-card-bottom-2 mt-2">
// 									<h4 className="m-b0">Application Sent</h4>
// 								</div>
// 							</div>
// 						</div>
// 					</div>

// 					{/* Card 3 - In Progress */}
// 					<div className="col-xl-6 col-lg-6 col-md-12 mb-3">
// 						<div className="panel panel-default">
// 							<div
// 								className="panel-body wt-panel-body dashboard-card-2"
// 								style={{ backgroundColor: "#fff3e0" }}
// 							>
// 								<div className="wt-card-wrap-2 d-flex align-items-center justify-content-between">
// 									<div className="wt-card-icon-2">
// 										<i className="flaticon-envelope" />
// 									</div>
// 									<div className="wt-card-right counter fw-bold fs-4 text-warning">
// 										<CountUp end={28} duration={2} />
// 									</div>
// 								</div>
// 								<div className="wt-card-bottom-2 mt-2">
// 									<h4 className="m-b0">In Progress</h4>
// 								</div>
// 							</div>
// 						</div>
// 					</div>

// 					{/* Card 4 - Assessments */}
// 					<div className="col-xl-6 col-lg-6 col-md-12 mb-3">
// 						<div className="panel panel-default">
// 							<div
// 								className="panel-body wt-panel-body dashboard-card-2"
// 								style={{ backgroundColor: "#e8f5e9" }}
// 							>
// 								<div className="wt-card-wrap-2 d-flex align-items-center justify-content-between">
// 									<div className="wt-card-icon-2">
// 										<i className="flaticon-bell" />
// 									</div>
// 									<div className="wt-card-right counter fw-bold fs-4 text-success">
// 										<CountUp end={18} duration={2} />
// 									</div>
// 								</div>
// 								<div className="wt-card-bottom-2 mt-2">
// 									<h4 className="m-b0">Assessments</h4>
// 								</div>
// 							</div>
// 						</div>
// 					</div>
// 				</div>
// 			</div>
// 		</>
// 	);
// }

// export default SectionCandidateOverview;


import { useEffect, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import CountUp from "react-countup";
import { useWebSocket } from '../../../../../contexts/WebSocketContext';

function SectionCandidateOverview() {
	const navigate = useNavigate();
	const { socket, joinCandidateRoom } = useWebSocket();
	const [stats, setStats] = useState({
		applied: 0,
		inProgress: 0,
		shortlisted: 0
	});
	const [candidate, setCandidate] = useState({ name: 'Loading...', credits: 0 });
	const [notifications, setNotifications] = useState([]);

	useEffect(() => {
		fetchDashboardData();
		// Set up interval to refresh data every 30 seconds
		const interval = setInterval(fetchDashboardData, 30000);
		return () => clearInterval(interval);
	}, []);

	// WebSocket effect for real-time credit updates
	useEffect(() => {
		if (socket && candidate.name !== 'Loading...') {
			// Get candidate ID from token
			const token = localStorage.getItem('candidateToken');
			if (token) {
				try {
					const payload = JSON.parse(atob(token.split('.')[1]));
					const candidateId = payload.id;
					
					// Join candidate room for real-time updates
					joinCandidateRoom(candidateId);
					
					// Listen for credit updates
					socket.on('credit-updated', (data) => {
						console.log('Credit update received:', data);
						if (data.candidateId === candidateId) {
							setCandidate(prev => ({
								...prev,
								credits: data.credits
							}));
							
							// Add visual feedback
							const creditElement = document.querySelector('.counter');
							if (creditElement) {
								creditElement.classList.add('credit-pulse');
								setTimeout(() => {
									creditElement.classList.remove('credit-pulse');
								}, 500);
							}
							
							// Show notification
							if (window.Notification && Notification.permission === 'granted') {
								new Notification('Credits Updated', {
									body: `Your credits have been updated to ${data.credits}`,
									icon: '/favicon.ico'
								});
							}
						}
					});
				} catch (error) {
					console.error('Error parsing token:', error);
				}
			}
		}

		return () => {
			if (socket) {
				socket.off('credit-updated');
			}
		};
	}, [socket, candidate.name, joinCandidateRoom]);

	// Request notification permission
	useEffect(() => {
		if (window.Notification && Notification.permission === 'default') {
			Notification.requestPermission();
		}
	}, []);

	const fetchDashboardData = async () => {
		try {
			const token = localStorage.getItem('candidateToken');
			if (!token) return;

			const [statsResponse, notificationResponse] = await Promise.all([
				fetch('http://localhost:5000/api/candidate/dashboard/stats', {
					headers: { 'Authorization': `Bearer ${token}` }
				}),
				fetch('http://localhost:5000/api/notifications/candidate', {
					headers: { 'Authorization': `Bearer ${token}` }
				})
			]);
			
			if (statsResponse.ok) {
				const data = await statsResponse.json();
				console.log('Dashboard API Response:', data);
				setStats(data.stats);
				setCandidate(data.candidate);
				console.log('Candidate credits:', data.candidate?.credits);
			}

			if (notificationResponse.ok) {
				const notificationData = await notificationResponse.json();
				if (notificationData.success) {
					setNotifications(notificationData.notifications || []);
				}
			}
		} catch (error) {
			console.error('Error fetching dashboard data:', error);
		}
	};

	const baseCards = [
		{
			bg: "#e0f7fa",
			icon: "flaticon-resume",
			color: "text-info",
			count: stats.applied,
			label: "Applied",
			clickable: true,
			onClick: () => {
				// Set flag to highlight company and position columns
				sessionStorage.setItem('highlightCompanyPosition', 'true');
				navigate('/candidate/status');
			}
		},
		{
			bg: "#fff3e0",
			icon: "flaticon-envelope",
			color: "text-warning",
			count: stats.inProgress,
			label: "In Progress",
			clickable: true,
			onClick: () => navigate('/candidate/status')
		},
		{
			bg: "#fff3e0",
			icon: "flaticon-bell",
			color: "text-warning",
			count: stats.shortlisted,
			label: "Shortlisted",
			clickable: true,
			onClick: () => {
				// Set a flag to highlight shortlisted applications
				sessionStorage.setItem('highlightShortlisted', 'true');
				navigate('/candidate/status');
			}
		},
	];

	const creditsCard = {
		bg: "#f0f4ff",
		icon: "flaticon-job",
		color: "text-primary",
		count: candidate.credits || 0,
		label: "Credits (From Excel)",
		clickable: false
	};

	// Show credits only for placement candidates
	const hasCredits = candidate.registrationMethod === 'placement';
	const cards = hasCredits ? [creditsCard, ...baseCards] : baseCards;

	return (
		<>
			<div className="d-flex justify-content-between align-items-center mb-4">
				<div>
					<h5 className="mb-1" style={{ color: '#111827', fontWeight: '700' }}>Dashboard Overview</h5>
					<p className="text-muted mb-0" style={{ fontSize: '0.875rem' }}>Track your job applications and profile activity</p>
				</div>
				{candidate.registrationMethod === 'placement' && (
					<div className="text-end">
						<small className="text-muted d-block" style={{ fontSize: '0.75rem' }}>Available Credits</small>
						<span className="fw-bold" style={{ color: '#f97316', fontSize: '1.1rem' }}>{candidate.credits || 0}</span>
					</div>
				)}
			</div>
			<div className="row" style={{ marginBottom: '2rem' }}>
				{cards.map((card, index) => (
					<div className={`col-xl-${hasCredits ? '3' : '4'} col-lg-${hasCredits ? '3' : '4'} col-md-12 mb-3`} key={index}>
						<div className="panel panel-default">
							<div 
								className="panel-body wt-panel-body dashboard-card-2" 
								style={{ 
									backgroundColor: card.bg,
									cursor: card.clickable ? 'pointer' : 'default'
								}}
								onClick={card.clickable ? card.onClick : undefined}
							>
								<div className="d-flex align-items-center" style={{ display: "flex", justifyContent: "flex-end" }}>
									<div className={`wt-card-icon-2 me-3 fs-2 ${card.color}`} style={{ lineHeight: "1" }}>
										<i className={card.icon} />
									</div>
									<div>
										<div className={`counter fw-bold fs-4 ${card.color}`}>
											<CountUp end={card.count} duration={2} />
										</div>
										<h5 className="mb-0 mt-1">{card.label}</h5>
										{card.label.includes('Excel') && candidate.placement?.collegeName && (
											<small className="text-muted d-block" style={{ fontSize: '0.75rem' }}>
												From: {candidate.placement.collegeName}
											</small>
										)}
									</div>
								</div>
							</div>
						</div>
					</div>
				))}
			</div>
		</>
	);
}

export default SectionCandidateOverview;
